<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Edit Profile - 98.css</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="https://unpkg.com/98.css" />
    <style>
        html, body { height: 100%; }
        body {
            margin: 0;
            background: #008080;
            font-family: "MS Sans Serif", Arial, sans-serif;
        }
        /* Center window */
        .desktop {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 24px;
        }
        .window { width: 420px; }
        .row {
            display: grid;
            grid-template-columns: 120px 1fr auto;
            gap: 10px 12px;
            align-items: center;
            margin-bottom: 10px;
        }
        .muted {
            color: #333;
            background: #fff;
            padding: 4px 6px;
            border: 1px solid #b5b5b5;
            box-shadow: inset -1px -1px #fff, inset 1px 1px #0a0a0a, inset -2px -2px #dfdfdf, inset 2px 2px grey;
        }
        .hidden { display: none; }
        .actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
            margin-top: 16px;
        }
        .status-bar {
            display: flex;
            gap: 8px;
            margin-top: 16px;
        }
        .status-bar-field { flex: 1; }
    </style>
</head>
<body>
<div class="desktop">
    <div class="window">
        <div class="title-bar">
            <div class="title-bar-text">Edit Profile</div>
            <div class="title-bar-controls">
                <button aria-label="Minimize"></button>
                <button aria-label="Maximize"></button>
                <button aria-label="Close"></button>
            </div>
        </div>
        <div class="window-body">
            <!-- Username row -->
            <div class="row" id="row-username">
                <label for="input-username">Username</label>
                <div>
                    <span id="display-username" class="muted"></span>
                    <input id="input-username" class="text-input hidden" type="text" />
                </div>
                <div>
                    <button id="btn-edit-username">Edit</button>
                    <button id="btn-save-username" class="hidden default">Save</button>
                    <button id="btn-cancel-username" class="hidden">Cancel</button>
                </div>
            </div>

            <!-- Email row -->
            <div class="row" id="row-email">
                <label for="input-email">Email</label>
                <div>
                    <span id="display-email" class="muted"></span>
                    <input id="input-email" class="text-input hidden" type="email" />
                </div>
                <div>
                    <button id="btn-edit-email">Edit</button>
                    <button id="btn-save-email" class="hidden default">Save</button>
                    <button id="btn-cancel-email" class="hidden">Cancel</button>
                </div>
            </div>

            <hr />

            <!-- Change password section -->
            <div id="password-section-collapsed">
                <button id="btn-change-password">Change Password…</button>
            </div>

            <div id="password-section" class="hidden">
                <fieldset>
                    <legend>Password</legend>
                    <div class="field-row" style="align-items:center;">
                        <label for="pwd-current" style="width:120px;">Current</label>
                        <input id="pwd-current" type="password" class="text-input" />
                    </div>
                    <div class="field-row" style="align-items:center;">
                        <label for="pwd-new" style="width:120px;">New</label>
                        <input id="pwd-new" type="password" class="text-input" />
                    </div>
                    <div class="field-row" style="align-items:center;">
                        <label for="pwd-confirm" style="width:120px;">Confirm</label>
                        <input id="pwd-confirm" type="password" class="text-input" />
                    </div>
                    <div class="actions">
                        <button id="btn-cancel-password">Cancel</button>
                        <button id="btn-save-password" class="default">Save</button>
                    </div>
                </fieldset>
            </div>

            <div class="status-bar">
                <p class="status-bar-field" id="status">Ready</p>
                <p class="status-bar-field" id="caps">Caps Lock: Off</p>
                <p class="status-bar-field" id="num">Num Lock: Unknown</p>
            </div>
        </div>
    </div>
</div>
<script src="script/utils/updateNumCaps.js"></script>
<script>const TOKEN = "XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX"</script>
<script>
    const BASE_URL = 'https://pi.linadu.live';

    const statusEl = document.getElementById("status");

    // Display elements
    const dispUsername = document.getElementById("display-username");
    const dispEmail = document.getElementById("display-email");

    // Inputs
    const inUsername = document.getElementById("input-username");
    const inEmail = document.getElementById("input-email");

    // Username buttons
    const btnEditUser = document.getElementById("btn-edit-username");
    const btnSaveUser = document.getElementById("btn-save-username");
    const btnCancelUser = document.getElementById("btn-cancel-username");

    // Email buttons
    const btnEditEmail = document.getElementById("btn-edit-email");
    const btnSaveEmail = document.getElementById("btn-save-email");
    const btnCancelEmail = document.getElementById("btn-cancel-email");

    // Password section
    const btnChangePw = document.getElementById("btn-change-password");
    const pwSectionCollapsed = document.getElementById("password-section-collapsed");
    const pwSection = document.getElementById("password-section");
    const btnCancelPw = document.getElementById("btn-cancel-password");
    const btnSavePw = document.getElementById("btn-save-password");
    const pwdCurrent = document.getElementById("pwd-current");
    const pwdNew = document.getElementById("pwd-new");
    const pwdConfirm = document.getElementById("pwd-confirm");

    function setStatus(msg) { statusEl.textContent = msg; }

    function authHeaders(extra = {}) {
        return { Authorization: `Bearer ${TOKEN}`, ...extra };
    }


    async function handleJsonResponse(res) {
        const json = await res.json();
        //console.log(json)
        //if (!res.ok) {
        //    const msg = json?.message || json?.error || `${res.status} ${res.statusText}`;
        //    throw new Error(msg);
        //}
        if (json && json.success === false) {
            console.log(json);
            const msg = json.error.message || 'Operation failed';
            throw new Error(msg);
        }
        return json;
    }

    function toggleEdit(group, editing) {
        const disp = group.querySelector("span.muted");
        const input = group.querySelector("input.text-input");
        const [btnEdit, btnSave, btnCancel] = group.querySelectorAll("button");

        if (editing) {
            disp.classList.add("hidden");
            input.classList.remove("hidden");
            btnEdit.classList.add("hidden");
            btnSave.classList.remove("hidden");
            btnCancel.classList.remove("hidden");
            input.focus();
            input.select?.();
        } else {
            disp.classList.remove("hidden");
            input.classList.add("hidden");
            btnEdit.classList.remove("hidden");
            btnSave.classList.add("hidden");
            btnCancel.classList.add("hidden");
        }
    }

    async function loadProfile() {
        try {
            setStatus("Loading profile…");
            const res = await fetch(`${BASE_URL}/api/profile`, {
                method: "GET",
                headers: authHeaders({ Accept: "application/json" })
            });
            const json = await handleJsonResponse(res);
            const data = json?.data || {};
            dispUsername.textContent = data.username || "";
            dispEmail.textContent = data.email || "";
            inUsername.value = data.username || "";
            inEmail.value = data.email || "";
            setStatus("Profile loaded");
        } catch (e) {
            setStatus("Error: " + e.message);
        }
    }

    // Username edit flow
    btnEditUser.addEventListener("click", () => toggleEdit(document.getElementById("row-username"), true));
    btnCancelUser.addEventListener("click", () => {
        inUsername.value = dispUsername.textContent;
        toggleEdit(document.getElementById("row-username"), false);
        setStatus("Canceled");
    });
    btnSaveUser.addEventListener("click", async () => {
        const username = inUsername.value.trim();
        if (!username) { setStatus("Username cannot be empty"); return; }
        setStatus("Saving username…");
        try {
            const res = await fetch(`${BASE_URL}/api/profile`, {
                method: "PUT",
                headers: authHeaders({ "Content-Type": "application/json" }),
                body: JSON.stringify({ username })
            });
            await handleJsonResponse(res);
            dispUsername.textContent = username;
            toggleEdit(document.getElementById("row-username"), false);
            setStatus("Username updated");
        } catch (e) {
            setStatus("Error: " + e.message);
        }
    });

    // Email edit flow
    btnEditEmail.addEventListener("click", () => toggleEdit(document.getElementById("row-email"), true));
    btnCancelEmail.addEventListener("click", () => {
        inEmail.value = dispEmail.textContent;
        toggleEdit(document.getElementById("row-email"), false);
        setStatus("Canceled");
    });
    btnSaveEmail.addEventListener("click", async () => {
        const email = inEmail.value.trim();
        if (!email) { setStatus("Email cannot be empty"); return; }
        setStatus("Saving email…");
        try {
            const res = await fetch(`${BASE_URL}/api/profile`, {
                method: "PUT",
                headers: authHeaders({ "Content-Type": "application/json" }),
                body: JSON.stringify({ email })
            });
            await handleJsonResponse(res);
            dispEmail.textContent = email;
            toggleEdit(document.getElementById("row-email"), false);
            setStatus("Email updated");
        } catch (e) {
            setStatus("Error: " + e.message);
        }
    });

    // Password editor
    btnChangePw.addEventListener("click", () => {
        pwSectionCollapsed.classList.add("hidden");
        pwSection.classList.remove("hidden");
        pwdCurrent.focus();
    });
    btnCancelPw.addEventListener("click", () => {
        pwSectionCollapsed.classList.remove("hidden");
        pwSection.classList.add("hidden");
        pwdCurrent.value = "";
        pwdNew.value = "";
        pwdConfirm.value = "";
        setStatus("Canceled");
    });
    btnSavePw.addEventListener("click", async () => {
        const current = pwdCurrent.value;
        const next = pwdNew.value;
        const confirm = pwdConfirm.value;
        if (!current || !next || !confirm) { setStatus("Fill all password fields"); return; }
        if (next !== confirm) { setStatus("Passwords do not match"); return; }
        setStatus("Saving password…");
        try {
            const res = await fetch(`${BASE_URL}/api/profile/password`, {
                method: "POST",
                headers: authHeaders({ "Content-Type": "application/json" }),
                body: JSON.stringify({ current_password: current, new_password: next })
            });
            await handleJsonResponse(res);
            pwdCurrent.value = "";
            pwdNew.value = "";
            pwdConfirm.value = "";
            pwSectionCollapsed.classList.remove("hidden");
            pwSection.classList.add("hidden");
            setStatus("Password updated");
        } catch (e) {
            setStatus("Error: " + e.message);
        }
    });

    // Init
    loadProfile();
</script>

</body>
</html>
